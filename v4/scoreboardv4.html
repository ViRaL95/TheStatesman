<!DOCTYPE HTML>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="scoreboardv4.css">
	<script src="http://yui.yahooapis.com/3.18.1/build/yui/yui-min.js"></script>
</head>	
<body>
<h2 id = "scoreboard_heading">SCOREBOARD</h2>
<div id = "table_wrapper">

		<div id="header" onchange="readRSS();">
				<form id="left">
				<select id="gender" onchange="changeOptions();">
	                <option value="Men">Men</option>
	                <option value="Women">Women</option>
	            </select>
	            </form>

	        	<form id="right">
	            <select id="sport">
					<option value="Baseball">Baseball</option>
					<option value="Basketball">Basketball</option>
					<option value="Football">Football</option>
					<option value="Lacrosse">Lacrosse</option>
					<option value="Soccer">Soccer</option>
				</select>
				</form>
  		</div>
		
		<div id="tbody">			
			<table id = "gameTable">

	
			</table>
		</div>
</div>


<script>

	readRSS();

	//changeOptions() changes the sport dropdown menu depending on gender selected
	function changeOptions() {
		var gender = document.getElementById("gender").value;
		var sport = document.getElementById("sport");

		var men_sport = ['Baseball', 'Basketball', 'Football', 'Lacrosse', 'Soccer'];
		var women_sport = ['Basketball', 'Lacrosse', 'Soccer', 'Softball', 'Volleyball'];


		if(gender=="Women"){
			for(i=0;i<women_sport.length;i++){
				sport.options[i] = new Option(women_sport[i]);
			}
		}

		if(gender == "Men"){
			for(i=0;i<men_sport.length;i++){
				sport.options[i] = new Option(men_sport[i]);
			}			
		}
	}

	//This function takes reads gender and sport from the dropdown menu and returns an ID number that is correlated to an RSS feed
	function returnSportID() {
		var gender = document.getElementById("gender").value;
		var sport = document.getElementById("sport").value;

		if (gender=="Women"){
			switch (sport) {
				case 'Basketball':
					return '12';
					break;
				case 'Lacrosse':
					return '13';
					break;
				case 'Soccer':
					return '14';
					break;
				case 'Softball':
					return '10';
					break;
				case 'Volleyball':
					return '17';
					break;
			}
		}

		if (gender=="Men"){
			switch (sport) {
				case 'Baseball':
					return '1';
					break;
				case 'Basketball':
					return '5';
					break;
				case 'Football':
					return '3';
					break;
				case 'Lacrosse':
					return '6';
					break;
				case 'Soccer':
					return '7';
					break;
			}
		}
	}


	function readRSS() {

		clearTable();


		//Use Yahoo Query Language (YQL) to read RSS feed from Stony Brook Athletics.
		YUI().use('yql', function(Y){
			var sportID = returnSportID();

			/*Different sports have different RSS feed. We use the returnSportID() function to return the ID number of the selected
			and concat to our query request*/
			var query = 'select title, description from rss where url = "http://stonybrookathletics.com/calendar.ashx/calendar.rss?sport_id='
			query = query.concat(sportID);
			query = query.concat('\"');
			
			var q = Y.YQL(query, function(r){
				var index=0;
				while (r.query.results.item[index] != null) {
					var game = r.query.results.item[index].title
					//Populate table
					populateTable(game);


					index++
				}
			})
		})
}

//Parse date from text. Date is before the first space. Find the index of the space, then parse data before it.
function parseDate(text) {
	var date;
	var space = text.indexOf(' ');
	date = text.substring(0, space);
	date = date.trim();

	//Checks to make sure date is in correct format.
	if (!date.includes('/')) {
		date = "ERROR";
	}
	return date;
}

//Parse time from text. Locate the string AM or PM and concatenate the date from it.
function parseTime(text) {
	var time;
	if (text.includes('PM') || text.includes('AM')) {
		var start = text.indexOf(' ');
		var end = text.indexOf('M');
		time = text.substring(start + 1, end+1);
	}
	else {
		time = "";
	}
	time = time.trim();
	return time;
}
//Parse location and opponent from text. Locates string at or vs and concatenate the location from it.
function parseMatch(text) {
	var location;
	var opponent;
	if (text.includes(' at ')) {
		location = 'at';
		opponent = text.substring(text.indexOf(' at ') + 3, text.length);
	}

	if (text.includes(' vs ')) {
		location = 'vs';
		opponent = text.substring(text.indexOf(' vs ') + 3, text.length);
	}

	opponent = opponent.trim();

	/*RSS feed includes an extra space between vs/at and opponent. 
	For the sake of saving one pixel, we included this convulated method.*/
	var match = "SBU ".concat(location).concat(' ').concat(opponent);
	return match;
}

//Parse WL from text. Locates brackets and concatenate W or L between it.
function parseWL(text) {
	var WL;
	if (text.includes('[')) {
		var leftBracket = text.indexOf('[');
		var rightBracket = text.indexOf(']');
		WL = text.substring(leftBracket+1, rightBracket);
	}
	else {
		WL = '-';
	}
	WL = WL.trim();
	return WL;
}

function populateTable(game) {
	var table = document.getElementById("gameTable");


	var row = table.insertRow(-1);

	var cell1 = row.insertCell(0);
	var cell2 = row.insertCell(1);
	var cell3 = row.insertCell(2);

	row.className = "teams";
	
	cell1.className = "date";
	cell1.colSpan = "1";
	
	cell2.className = "game";
	cell2.colSpan = "2";
	
	cell3.className = "score";
	cell3.colSpan = "1";

	cell1.innerHTML = parseDate(game).concat(' ').concat(parseTime(game));
	cell2.innerHTML = parseMatch(game);
	cell3.innerHTML = parseWL(game);
}

function clearTable(){

	var table = document.getElementById("gameTable");
	var rowCount = table.rows.length;
	
	while(table.rows.length > 0) {
		table.deleteRow(0);
	}
}

</script>

</body>
</html>